/**
 * Main JavaScript
 * Handles navigation, mobile menu, and language switching
 */

(function() {
    'use strict';

    // Mobile Menu Toggle
    const menuToggle = document.getElementById('menu-toggle');
    const navPrimary = document.getElementById('nav-primary');

    if (menuToggle && navPrimary) {
        menuToggle.addEventListener('click', function() {
            const isOpen = navPrimary.classList.toggle('is-open');
            menuToggle.classList.toggle('is-open');
            menuToggle.setAttribute('aria-expanded', isOpen);
        });

        // Close menu when clicking a link
        const navLinks = navPrimary.querySelectorAll('a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                navPrimary.classList.remove('is-open');
                menuToggle.classList.remove('is-open');
                menuToggle.setAttribute('aria-expanded', 'false');
            });
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!menuToggle.contains(event.target) && !navPrimary.contains(event.target)) {
                navPrimary.classList.remove('is-open');
                menuToggle.classList.remove('is-open');
                menuToggle.setAttribute('aria-expanded', 'false');
            }
        });
    }

    // Dropdown Menu Toggle (for mobile)
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');

    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            // Only handle clicks on mobile (when nav is in mobile mode)
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                e.preventDefault();
                const parentLi = this.closest('.has-submenu');
                const submenu = parentLi.querySelector('.submenu');
                const isExpanded = this.getAttribute('aria-expanded') === 'true';

                // Close all other submenus
                dropdownToggles.forEach(otherToggle => {
                    if (otherToggle !== this) {
                        otherToggle.setAttribute('aria-expanded', 'false');
                        const otherParent = otherToggle.closest('.has-submenu');
                        const otherSubmenu = otherParent.querySelector('.submenu');
                        if (otherSubmenu) {
                            otherSubmenu.style.display = 'none';
                        }
                    }
                });

                // Toggle current submenu
                this.setAttribute('aria-expanded', !isExpanded);
                if (submenu) {
                    submenu.style.display = isExpanded ? 'none' : 'block';
                }
            }
        });
    });

    // Language Selector
    const languageSelect = document.getElementById('language-select');

    if (languageSelect) {
        languageSelect.addEventListener('change', function() {
            const newLang = this.value;
            const currentPath = window.location.pathname;

            // Extract current page path after language code
            const pathParts = currentPath.split('/').filter(part => part);
            const currentLang = pathParts[0];

            // Replace language in path
            let newPath = currentPath.replace('/' + currentLang + '/', '/' + newLang + '/');

            // Redirect to new language
            window.location.href = newPath;
        });
    }

    // Active Navigation Link
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-primary a');

    navLinks.forEach(link => {
        if (link.getAttribute('href') === currentPath ||
            link.getAttribute('href') + '/' === currentPath ||
            link.getAttribute('href') === currentPath + '/') {
            link.classList.add('active');
            link.setAttribute('aria-current', 'page');
        }
    });

    // Smooth Scroll for Anchor Links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const href = this.getAttribute('href');
            if (href !== '#' && href !== '') {
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
    });

    // Contact Form Submission (Web3Forms)
    const contactForm = document.getElementById('contact-form');

    if (contactForm) {
        const statusDiv = document.getElementById('form-status');
        const submitButton = contactForm.querySelector('button[type="submit"]');
        const originalButtonText = submitButton ? submitButton.textContent : '';

        // Get language from hidden field
        const langInput = contactForm.querySelector('input[name="language"]');
        const lang = langInput ? langInput.value : 'en';

        // Translations
        const messages = {
            en: {
                sending: 'Sending...',
                success: 'Message sent successfully! We\'ll get back to you soon.',
                error: 'Error sending message. Please try again or contact us via email.',
                required: 'This field is required',
                invalidEmail: 'Please enter a valid email address'
            },
            ca: {
                sending: 'Enviant...',
                success: 'Missatge enviat correctament! Ens posarem en contacte aviat.',
                error: 'Error enviant el missatge. Si us plau, torna-ho a provar o contacta\'ns per email.',
                required: 'Aquest camp és obligatori',
                invalidEmail: 'Si us plau, introdueix un email vàlid'
            }
        };

        const msg = messages[lang] || messages.en;

        contactForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Basic validation
            let isValid = true;
            const requiredFields = this.querySelectorAll('[required]');

            requiredFields.forEach(field => {
                const errorSpan = document.getElementById(field.id + '-error');

                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('error');
                    if (errorSpan) {
                        errorSpan.textContent = msg.required;
                    }
                } else {
                    field.classList.remove('error');
                    if (errorSpan) {
                        errorSpan.textContent = '';
                    }
                }
            });

            // Email validation
            const emailField = this.querySelector('[type="email"]');
            if (emailField && emailField.value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const errorSpan = document.getElementById(emailField.id + '-error');

                if (!emailRegex.test(emailField.value)) {
                    isValid = false;
                    emailField.classList.add('error');
                    if (errorSpan) {
                        errorSpan.textContent = msg.invalidEmail;
                    }
                }
            }

            if (!isValid) {
                return;
            }

            // Show sending state
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = msg.sending;
            }

            // Submit form via fetch
            const formData = new FormData(this);

            try {
                const response = await fetch('https://api.web3forms.com/submit', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Success - redirect to thank you page
                    const currentPath = window.location.pathname;
                    const pathParts = currentPath.split('/').filter(part => part);
                    const currentLang = pathParts[0] || lang;
                    window.location.href = '/' + currentLang + '/thanks/';
                } else {
                    // Error from Web3Forms
                    statusDiv.textContent = msg.error;
                    statusDiv.className = 'form-status error';
                }
            } catch (error) {
                // Network error
                statusDiv.textContent = msg.error;
                statusDiv.className = 'form-status error';
            } finally {
                // Reset button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            }
        });
    }

    // Print Friendly
    window.addEventListener('beforeprint', function() {
        document.body.classList.add('is-printing');
    });

    window.addEventListener('afterprint', function() {
        document.body.classList.remove('is-printing');
    });

    // Splash Screen Animation (Homepage Only)
    function initSplashScreen() {
        // Only run on homepage
        const isHomepage = currentPath === '/' ||
                          currentPath.match(/^\/(ca|en)\/?$/);

        if (!isHomepage) {
            return;
        }

        // Check if splash was already shown this session
        const splashShown = sessionStorage.getItem('splashShown');

        if (splashShown) {
            return;
        }

        // Mark splash as shown for this session
        sessionStorage.setItem('splashShown', 'true');

        // Add splash-active class to body
        document.body.classList.add('splash-active');

        // Create splash screen element
        const splashScreen = document.createElement('div');
        splashScreen.className = 'splash-screen';
        splashScreen.innerHTML = `
            <div class="splash-logo">
                <img src="/assets/images/logo.png" alt="RunAnalytics" width="200" height="200">
                <div class="splash-logo-text">RunAnalytics</div>
            </div>
        `;

        // Insert splash screen at the beginning of body
        document.body.insertBefore(splashScreen, document.body.firstChild);

        // Remove splash screen after animation completes
        setTimeout(function() {
            // Remove splash-active class to reveal content
            document.body.classList.remove('splash-active');

            // Add content-reveal animation to main sections
            const header = document.querySelector('.site-header');
            const mainContent = document.querySelector('.main-content');

            if (header) {
                header.classList.add('content-reveal');
            }
            if (mainContent) {
                mainContent.classList.add('content-reveal');
            }

            // Remove splash screen from DOM after fade out
            setTimeout(function() {
                if (splashScreen && splashScreen.parentNode) {
                    splashScreen.parentNode.removeChild(splashScreen);
                }
            }, 600); // Match CSS animation duration
        }, 2800); // Total splash duration (2.2s animation + 0.6s buffer)
    }

    // Initialize splash screen when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSplashScreen);
    } else {
        initSplashScreen();
    }

    // Dark Mode Toggle
    function initThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle');
        if (!themeToggle) return;

        // Check for saved theme preference or default to system preference
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        // Set initial theme
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.documentElement.classList.add('dark-mode');
        } else {
            document.documentElement.classList.remove('dark-mode');
        }

        // Toggle theme on button click
        themeToggle.addEventListener('click', function() {
            const isDark = document.documentElement.classList.toggle('dark-mode');

            // Save preference to localStorage
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            // Update aria-label
            this.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
        });

        // Update aria-label on load
        const isDark = document.documentElement.classList.contains('dark-mode');
        themeToggle.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
    }

    // Initialize theme toggle when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initThemeToggle);
    } else {
        initThemeToggle();
    }

    // App Download Banner Management
    function initAppBanner() {
        const banner = document.getElementById('app-download-banner');
        const dismissBtn = document.getElementById('dismiss-app-banner');

        if (!banner || !dismissBtn) return;

        // Check if user has previously dismissed the banner
        const isDismissed = localStorage.getItem('appBannerDismissed') === 'true';

        if (isDismissed) {
            // Keep banner hidden and add class to body
            banner.classList.add('hidden');
            document.body.classList.add('banner-dismissed');
        } else {
            // Show banner after small delay for smoother UX
            setTimeout(() => {
                banner.classList.remove('hidden');
                document.body.classList.remove('banner-dismissed');
            }, 500);
        }

        // Handle dismiss button click
        dismissBtn.addEventListener('click', function() {
            // Hide banner with animation
            banner.classList.add('hidden');
            document.body.classList.add('banner-dismissed');

            // Save dismissal state to localStorage
            localStorage.setItem('appBannerDismissed', 'true');
        });
    }

    // Initialize app banner when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAppBanner);
    } else {
        initAppBanner();
    }

})();
