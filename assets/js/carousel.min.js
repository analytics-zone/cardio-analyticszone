/**
 * Carousel Component
 * Enhanced carousel with arrow navigation, dots, keyboard support, and touch gestures
 */

(function() {
  'use strict';

  class Carousel {
    constructor(container) {
      this.container = container;
      this.carousel = container.querySelector('.screenshots-carousel');
      this.items = container.querySelectorAll('.screenshot-item');
      this.prevBtn = container.querySelector('.carousel-btn-prev');
      this.nextBtn = container.querySelector('.carousel-btn-next');
      this.dotsContainer = container.querySelector('#carouselDots');

      this.currentIndex = 0;
      this.itemWidth = 0;
      this.isDragging = false;
      this.startX = 0;
      this.scrollLeft = 0;

      this.init();
    }

    init() {
      if (!this.carousel || this.items.length === 0) {
        return;
      }

      this.createDots();
      this.updateDots();
      this.updateButtons();
      this.attachEventListeners();
      this.calculateItemWidth();
    }

    createDots() {
      if (!this.dotsContainer) return;

      this.dotsContainer.innerHTML = '';
      this.items.forEach((_, index) => {
        const dot = document.createElement('button');
        dot.classList.add('dot');
        dot.setAttribute('role', 'tab');
        dot.setAttribute('aria-label', `View screenshot ${index + 1}`);
        dot.setAttribute('aria-selected', index === 0 ? 'true' : 'false');
        dot.addEventListener('click', () => this.goToSlide(index));
        this.dotsContainer.appendChild(dot);
      });
    }

    calculateItemWidth() {
      if (this.items.length > 0) {
        const firstItem = this.items[0];
        const style = window.getComputedStyle(firstItem);
        const marginRight = parseFloat(style.marginRight) || 0;
        this.itemWidth = firstItem.offsetWidth + marginRight;
      }
    }

    attachEventListeners() {
      // Arrow buttons
      if (this.prevBtn) {
        this.prevBtn.addEventListener('click', () => this.prev());
      }
      if (this.nextBtn) {
        this.nextBtn.addEventListener('click', () => this.next());
      }

      // Keyboard navigation
      this.carousel.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          this.prev();
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          this.next();
        }
      });

      // Touch/Mouse drag
      this.carousel.addEventListener('mousedown', (e) => this.startDrag(e));
      this.carousel.addEventListener('touchstart', (e) => this.startDrag(e), { passive: true });

      this.carousel.addEventListener('mousemove', (e) => this.drag(e));
      this.carousel.addEventListener('touchmove', (e) => this.drag(e), { passive: false });

      this.carousel.addEventListener('mouseup', (e) => this.endDrag(e));
      this.carousel.addEventListener('touchend', (e) => this.endDrag(e));
      this.carousel.addEventListener('mouseleave', (e) => this.endDrag(e));

      // Scroll event to update active dot
      this.carousel.addEventListener('scroll', () => {
        this.updateCurrentIndex();
        this.updateDots();
        this.updateButtons();
      });

      // Resize event
      window.addEventListener('resize', () => {
        this.calculateItemWidth();
      });
    }

    startDrag(e) {
      this.isDragging = true;
      this.carousel.style.cursor = 'grabbing';
      this.carousel.style.scrollBehavior = 'auto';

      const touch = e.type === 'touchstart' ? e.touches[0] : e;
      this.startX = touch.pageX - this.carousel.offsetLeft;
      this.scrollLeft = this.carousel.scrollLeft;
    }

    drag(e) {
      if (!this.isDragging) return;

      e.preventDefault();
      const touch = e.type === 'touchmove' ? e.touches[0] : e;
      const x = touch.pageX - this.carousel.offsetLeft;
      const walk = (x - this.startX) * 2; // Multiply by 2 for faster scroll
      this.carousel.scrollLeft = this.scrollLeft - walk;
    }

    endDrag(e) {
      if (!this.isDragging) return;

      this.isDragging = false;
      this.carousel.style.cursor = 'grab';
      this.carousel.style.scrollBehavior = 'smooth';

      // Snap to nearest item
      this.updateCurrentIndex();
      this.goToSlide(this.currentIndex);
    }

    updateCurrentIndex() {
      if (this.itemWidth === 0) {
        this.calculateItemWidth();
      }

      const scrollPosition = this.carousel.scrollLeft;
      const index = Math.round(scrollPosition / this.itemWidth);
      this.currentIndex = Math.max(0, Math.min(index, this.items.length - 1));
    }

    updateDots() {
      if (!this.dotsContainer) return;

      const dots = this.dotsContainer.querySelectorAll('.dot');
      dots.forEach((dot, index) => {
        if (index === this.currentIndex) {
          dot.classList.add('active');
          dot.setAttribute('aria-selected', 'true');
        } else {
          dot.classList.remove('active');
          dot.setAttribute('aria-selected', 'false');
        }
      });
    }

    updateButtons() {
      if (this.prevBtn) {
        this.prevBtn.disabled = this.currentIndex === 0;
      }
      if (this.nextBtn) {
        this.nextBtn.disabled = this.currentIndex === this.items.length - 1;
      }
    }

    prev() {
      if (this.currentIndex > 0) {
        this.goToSlide(this.currentIndex - 1);
      }
    }

    next() {
      if (this.currentIndex < this.items.length - 1) {
        this.goToSlide(this.currentIndex + 1);
      }
    }

    goToSlide(index) {
      if (index < 0 || index >= this.items.length) return;

      this.currentIndex = index;
      const scrollPosition = this.currentIndex * this.itemWidth;

      this.carousel.scrollTo({
        left: scrollPosition,
        behavior: 'smooth'
      });

      this.updateDots();
      this.updateButtons();
    }
  }

  // Initialize all carousels
  function initCarousels() {
    const containers = document.querySelectorAll('.carousel-wrapper');
    containers.forEach(container => {
      new Carousel(container);
    });
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarousels);
  } else {
    initCarousels();
  }
})();
