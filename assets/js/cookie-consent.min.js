/**
 * Cookie Consent Banner
 * GDPR-compliant cookie consent management
 */

(function() {
    'use strict';

    const CONSENT_KEY = 'cookieConsent';
    const CONSENT_TIMESTAMP_KEY = 'cookieConsentTimestamp';
    const CONSENT_EXPIRY_DAYS = 365;

    const banner = document.getElementById('cookie-banner');
    const acceptButton = document.getElementById('cookie-accept');
    const declineButton = document.getElementById('cookie-decline');

    if (!banner || !acceptButton || !declineButton) {
        console.error('Cookie banner elements not found');
        return;
    }

    /**
     * Check if consent is still valid
     */
    function isConsentValid() {
        const timestamp = localStorage.getItem(CONSENT_TIMESTAMP_KEY);
        if (!timestamp) return false;

        const consentDate = new Date(parseInt(timestamp));
        const now = new Date();
        const daysSinceConsent = (now - consentDate) / (1000 * 60 * 60 * 24);

        return daysSinceConsent < CONSENT_EXPIRY_DAYS;
    }

    /**
     * Check if we should show the banner
     */
    function shouldShowBanner() {
        const consent = localStorage.getItem(CONSENT_KEY);

        // Show if no consent or consent expired
        if (!consent || !isConsentValid()) {
            return true;
        }

        return false;
    }

    /**
     * Show the banner
     */
    function showBanner() {
        banner.classList.add('is-visible');
        banner.setAttribute('aria-hidden', 'false');
    }

    /**
     * Hide the banner
     */
    function hideBanner() {
        banner.classList.remove('is-visible');
        banner.setAttribute('aria-hidden', 'true');
    }

    /**
     * Save consent choice
     */
    function saveConsent(accepted) {
        const choice = accepted ? 'accepted' : 'declined';
        localStorage.setItem(CONSENT_KEY, choice);
        localStorage.setItem(CONSENT_TIMESTAMP_KEY, Date.now().toString());

        // Dispatch custom event for other scripts to listen
        const event = new CustomEvent('consentChanged', {
            detail: { consent: choice }
        });
        window.dispatchEvent(event);

        console.log('Cookie consent:', choice);
    }

    /**
     * Handle accept
     */
    function handleAccept() {
        saveConsent(true);
        hideBanner();

        // Reload to load analytics if needed
        setTimeout(() => {
            window.location.reload();
        }, 300);
    }

    /**
     * Handle decline
     */
    function handleDecline() {
        saveConsent(false);
        hideBanner();
    }

    /**
     * Initialize
     */
    function init() {
        // Check if we should show the banner
        if (shouldShowBanner()) {
            // Small delay for better UX
            setTimeout(showBanner, 1000);
        }

        // Event listeners
        acceptButton.addEventListener('click', handleAccept);
        declineButton.addEventListener('click', handleDecline);

        // Keyboard accessibility
        banner.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                handleDecline();
            }
        });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Expose API for testing/debugging
    window.cookieConsent = {
        get: () => localStorage.getItem(CONSENT_KEY),
        reset: () => {
            localStorage.removeItem(CONSENT_KEY);
            localStorage.removeItem(CONSENT_TIMESTAMP_KEY);
            window.location.reload();
        },
        show: showBanner
    };

})();
